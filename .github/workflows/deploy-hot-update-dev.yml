name: Deploy Live Update DEV

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true    
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.x
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Install Capawesome CLI
        run: npm install -g @capawesome/cli

      - name: Extract versionName
        id: version
        run: |
          VERSION_NAME=$(grep versionName android/app/build.gradle | sed -E 's/.*"([0-9.]+)".*/\1/')
          echo "versionName=$VERSION_NAME" >> $GITHUB_OUTPUT

          # Extract major version (before first dot)
          MAJOR_VERSION=$(echo "$VERSION_NAME" | cut -d '.' -f 1)
          echo "majorVersion=$MAJOR_VERSION" >> $GITHUB_OUTPUT

      - name: Define Live Update Channel
        id: channel
        run: |
          ENV_NAME="${{ vars.REACT_APP_ENV_DEV }}"   # dev OR prod
          MAJOR="${{ steps.version.outputs.majorVersion }}"
          CHANNEL_NAME="${ENV_NAME}-${MAJOR}"

          echo "channelName=$CHANNEL_NAME" >> $GITHUB_OUTPUT
          echo "Using channel: $CHANNEL_NAME"

      - name: Build project
        env:
          CI: false
          REACT_APP_API_KEY: ${{ secrets.REACT_APP_API_KEY }}
          REACT_APP_AUTH_DOMAIN: ${{ secrets.REACT_APP_AUTH_DOMAIN }}
          REACT_APP_PROJECT_ID: ${{ secrets.REACT_APP_PROJECT_ID }}
          REACT_APP_STORAGE_BUCKET: ${{ secrets.REACT_APP_STORAGE_BUCKET }}
          REACT_APP_MESSAGING_SENDER_ID: ${{ secrets.REACT_APP_MESSAGING_SENDER_ID }}
          REACT_APP_APP_ID: ${{ secrets.REACT_APP_APP_ID }}
          REACT_APP_MEASUREMENT_ID: ${{ secrets.REACT_APP_MEASUREMENT_ID}}
          REACT_APP_ALGOLIA_APP_ID: ${{ secrets.REACT_APP_ALGOLIA_APP_ID }}
          REACT_APP_ALGOLIA_API_KEY: ${{ secrets.REACT_APP_ALGOLIA_API_KEY }}
          REACT_APP_HOT_UPDATE_SERVER: ${{ secrets.SUPABASE_DEV_HOT_UPDATE_SERVER }}
          REACT_APP_ALGOLIA_INDEX_NAME: ${{ secrets.REACT_APP_ALGOLIA_INDEX_NAME}}
          REACT_APP_SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL}}
          REACT_APP_SUPABASE_KEY: ${{ secrets.REACT_APP_SUPABASE_KEY}}
          REACT_APP_CLIENT_ID: ${{ secrets.REACT_APP_CLIENT_ID}}
          REACT_APP_GROWTHBOOK_ID: ${{ secrets.REACT_APP_GROWTHBOOK_ID_DEV }}
          REACT_APP_RAPIDAPI_KEY: ${{ secrets.REACT_APP_RAPIDAPI_KEY }}
          REACT_APP_ENCRYPTION_KEY: ${{ secrets.REACT_APP_ENCRYPTION_KEY }}
          REACT_APP_SENTRY_DSN: ${{ secrets.REACT_APP_SENTRY_DSN }}
          REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID: ${{ secrets.REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID }}
          REACT_APP_ENV: ${{vars.REACT_APP_ENV_DEV}}
          REACT_APP_IS_HOT_UPDATE_ENABLED: ${{vars.REACT_IS_HOT_UPDATE_ENABLED}}
                
        run: export GENERATE_SOURCEMAP=false && npx craco build && npm run copy-build && npx @capawesome/cli manifests:generate --path build

      - name: Login to Capawesome Cloud
        env:
          CAPAWESOME_API_TOKEN: ${{ secrets.CAPAWESOME_API_TOKEN }}
        run: npx @capawesome/cli login --token "$CAPAWESOME_API_TOKEN"

      - name: Ensure live update channel exists
        env:
          REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID: ${{ secrets.REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID }}
        run: |
          CHANNEL="${{ steps.channel.outputs.channelName }}"
          echo "Checking channel: $CHANNEL"

          CHANNELS=$(npx @capawesome/cli apps:channels:list --appId "$REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID")
          if echo "$CHANNELS" | grep -q "$CHANNEL"; then
            echo "Channel '$CHANNEL' exists."
          else
            echo "Channel '$CHANNEL' does not exist. Creating..."
            npx @capawesome/cli apps:channels:create --appId "$REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID" --name "$CHANNEL"
            echo "Channel '$CHANNEL' created."
          fi

      - name: Upload manifest-based bundle to Capawesome Cloud
        env:
          REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID: ${{ secrets.REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID }}
        run: |
          CHANNEL="${{ steps.channel.outputs.channelName }}"

          npx @capawesome/cli apps:bundles:create \
            --appId "$REACT_APP_CAPACITOR_HOT_UPDATE_APP_ID" \
            --path build \
            --channel "$CHANNEL" \
            --artifact-type manifest \
            --custom-property version="${{ steps.version.outputs.versionName }}" \
            --commit-message "${{ github.event.head_commit.message || 'manual deploy' }}" \
            --commit-ref "${{ github.ref }}" \
            --commit-sha "${{ github.sha }}"

      - name: Done
        run: echo "Manifest-based bundle created and uploaded successfully."
